<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Kingshop POS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  
  <style>
    :root { --p: #1e3c72; --s: #2ecc71; --d: #e74c3c; --bg: #f0f2f5; --accent: #D4AF37; }
    body { background: var(--bg); padding-bottom: 80px; font-family: 'Montserrat', sans-serif; overflow-x: hidden; }
    .header { background: var(--p); color:white; padding:15px 20px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; justify-content: space-between; align-items: center; }
    .main-layout { display: flex; gap: 20px; align-items: flex-start; padding: 15px; }
    .list-column { flex: 1; }
    .panel-column { width: 350px; position: sticky; top: 10px; display: none; } 
    @media (min-width: 992px) { .panel-column { display: block; } }
    .card-product { background: white; border: none; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.1s; position: relative; border-left: 4px solid transparent; }
    .card-product:hover { transform: translateY(-2px); }
    .card-product.active { border-left-color: var(--accent); background: #fffbf0; border: 1px solid var(--accent); }
    .check-mark { position: absolute; top: 10px; right: 10px; color: var(--accent); font-weight: bold; display: none; }
    .card-product.active .check-mark { display: block; }
    .product-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 12px; flex-shrink: 0; border: 1px solid #eee; background: #fff; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 1.5rem; }
    .price-tag { font-weight: 700; color: #2e7d32; font-size: 1.1rem; }
    .cotizador-panel { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .input-line { border:none; border-bottom: 2px solid #eee; width:100%; text-align:center; font-weight:bold; outline:none; }
    .mobile-panel { position: fixed; bottom: 0; left: 0; width: 100%; background: white; z-index: 5000; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -5px 30px rgba(0,0,0,0.2); transform: translateY(110%); transition: transform 0.3s; }
    .mobile-panel.visible { transform: translateY(0); }
    .card-k { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: none; }
    .card-balance { padding: 25px; color: white; border-radius: 20px; text-align: center; background: linear-gradient(135deg, #11998e, #38ef7d); box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3); margin-bottom: 15px; }
    .nav-btm { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #eee; z-index: 1000; }
    .nav-btn { background: none; border: none; color: #aaa; display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; }
    .nav-btn.active { color: var(--p); font-weight: bold; }
    .file-upload-wrapper { position: relative; width: 100%; height: 150px; border: 2px dashed #ccc; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fafafa; overflow: hidden; }
    .preview-img { position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .btn-bi { background: rgba(255,255,255,0.2); border:none; color:white; border-radius: 8px; padding: 5px 10px; font-size: 0.8rem; text-decoration: none; transition: 0.2s; }
    .btn-bi:hover { background: rgba(255,255,255,0.4); color: white; }
    .prov-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .prov-item:last-child { border-bottom: none; }
    .btn-wa-mini { background: #25D366; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; text-decoration: none; }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner-border text-primary"></div><h6 class="mt-3 text-muted fw-bold">Conectando API...</h6></div>

  <div class="header">
    <div><h4 class="m-0 fw-bold">üëë Kingshop</h4><small class="opacity-75" id="user-display">...</small></div>
    <div class="d-flex gap-2">
        <a class="btn-bi" href="dashboard.html"><i class="bi bi-graph-up-arrow"></i> Stats</a>
        <button class="btn btn-light text-primary shadow-sm rounded-circle" style="width:45px; height:45px;" onclick="verBancos()"><i class="bi bi-bank2 fs-5"></i></button>
    </div>
  </div>

  <div class="container-fluid px-3">
    <div id="view-pos" class="view-sec">
      <div class="main-layout">
        <div class="list-column">
           <input type="text" id="pos-search" class="form-control mb-3 p-3 shadow-sm rounded-pill" placeholder="üîç Buscar para vender..." onkeyup="renderPos()">
           <div id="msg-empty-pos" class="text-center text-muted py-5" style="display:none;"><i class="bi bi-box-seam fs-1"></i><br>Sin productos</div>
           <div id="pos-list"></div>
        </div>
        <div class="panel-column"><div id="desktop-cart-container"></div></div>
      </div>
    </div>

    <div id="view-inv" class="view-sec" style="display:none; padding:15px;">
      <div class="d-flex gap-2 mb-3">
        <input type="text" id="inv-search" class="form-control" placeholder="üîç Buscar..." onkeyup="renderInv()">
        <button class="btn btn-info text-white" onclick="abrirModalProv()" title="Proveedores"><i class="fas fa-users"></i></button>
        <button class="btn btn-success" onclick="abrirModalWA()" title="Importar WA"><i class="fab fa-whatsapp"></i></button>
        <button class="btn btn-dark" onclick="abrirModalNuevo()">+</button>
      </div>
      <div id="inv-list"></div>
    </div>

    <div id="view-ped" class="view-sec" style="display:none; padding:15px;">
      <button class="btn btn-dark w-100 mb-3" onclick="new bootstrap.Modal('#modalPed').show()">+ Nuevo Pedido</button>
      <div id="ped-list"></div>
    </div>

    <div id="view-fin" class="view-sec" style="display:none; padding:15px;">
      <div class="card-balance"><small class="opacity-75">Saldo Disponible</small><h1 class="fw-bold display-4 my-1" id="bal-caja">...</h1></div>
      <div class="row g-2 mb-3">
         <div class="col-6"><div class="card-k p-2 text-center h-100"><small class="text-muted">Ventas Mes</small><h6 class="fw-bold text-primary mb-0" id="bal-ventas">...</h6></div></div>
         <div class="col-6"><div class="card-k p-2 text-center h-100"><small class="text-muted">Utilidad Real</small><h6 class="fw-bold text-success mb-0" id="bal-ganancia">...</h6></div></div>
      </div>
      <ul class="nav nav-pills nav-fill mb-3 bg-white rounded shadow-sm p-1">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#f-abono">Abono</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#f-gasto">Gasto</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#f-hist">Historial</a></li>
      </ul>
      <div class="tab-content">
         <div class="tab-pane fade show active" id="f-abono">
            <div class="card-k">
               <h6 class="text-success fw-bold">Registrar Pago</h6>
               <select id="ab-cli" class="form-select mb-2"></select>
               <input type="number" id="ab-monto" class="form-control mb-2" placeholder="Monto">
               <button class="btn btn-success w-100" onclick="doAbono()">REGISTRAR ABONO</button>
            </div>
         </div>
         <div class="tab-pane fade" id="f-gasto">
            <div class="card-k">
               <h6 class="text-danger fw-bold">Registrar Gasto</h6>
               <input type="text" id="g-desc" class="form-control mb-2" placeholder="Descripci√≥n">
               <select id="g-cat" class="form-select mb-2"><option>Transporte</option><option>Alimentaci√≥n</option><option>Papeler√≠a</option><option>Servicios</option><option>Otros</option></select>
               <input type="number" id="g-monto" class="form-control mb-2" placeholder="Valor">
               <label class="small text-muted">Vincular a venta:</label>
               <select id="g-vinculo" class="form-select mb-2"><option value="">-- Ninguna --</option></select>
               <button class="btn btn-danger w-100" onclick="doGasto()">REGISTRAR GASTO</button>
            </div>
         </div>
         <div class="tab-pane fade" id="f-hist"><div class="card-k" id="hist-list"></div></div>
      </div>
    </div>
  </div>

  <div id="mobile-cart" class="mobile-panel"></div>
  <button id="btn-float-cart" class="btn btn-warning rounded-circle shadow" style="position:fixed; bottom:80px; right:20px; width:60px; height:60px; z-index:4000; display:none; font-size:1.5rem;" onclick="toggleMobileCart()">üõí</button>

  <div class="nav-btm">
    <button class="nav-btn active" onclick="nav('pos',this)"><i class="fas fa-store fa-lg"></i>Vender</button>
    <button class="nav-btn" onclick="nav('inv',this)"><i class="fas fa-boxes fa-lg"></i>Inventario</button>
    <button class="nav-btn" onclick="nav('ped',this)"><i class="fas fa-clipboard-list"></i>Pedidos</button>
    <button class="nav-btn" onclick="nav('fin',this)"><i class="fas fa-chart-line fa-lg"></i>Finanzas</button>
  </div>

  <template id="tpl-cart">
    <div class="cotizador-panel">
       <div class="d-flex justify-content-between mb-2 align-items-center">
         <h5 class="fw-bold m-0">Cotizaci√≥n</h5>
         <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">üóëÔ∏è</button>
       </div>
       <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="c-iva" onchange="calcCart()"><label class="form-check-label small fw-bold" for="c-iva">Aplicar IVA (19%)</label></div>
       <div id="cart-items-list" class="mb-3 small text-muted fst-italic" style="max-height:100px; overflow-y:auto; border-bottom:1px solid #eee; padding-bottom:5px;">Selecciona productos...</div>
       <div class="row g-2 mb-3">
         <div class="col-4 text-center"><small>Util %</small><input id="c-util" type="number" class="input-line" value="30" oninput="calcCart()"></div>
         <div class="col-4 text-center"><small>Int %</small><input id="c-int" type="number" class="input-line" value="5" oninput="calcCart()"></div>
         <div class="col-4 text-center"><small>Cuotas</small><input id="c-cuotas" type="number" class="input-line" value="1" oninput="calcCart()"></div>
       </div>
       <div class="alert alert-light border text-center py-2 mb-3">
          <div class="d-flex justify-content-between"><span>Total:</span><strong id="res-cont" class="text-dark">$0</strong></div>
          <div id="row-cred" style="display:none; border-top:1px dashed #ccc; margin-top:5px; padding-top:5px;">
             <div class="d-flex justify-content-between text-success"><span>Inicial (30%):</span><strong id="res-ini">$0</strong></div>
             <div class="d-flex justify-content-between text-primary mt-1"><span>Restante:</span><strong id="res-cuota-val">$0</strong> <small id="res-cuota-txt">x 1</small></div>
          </div>
       </div>
       <input id="c-cliente" class="form-control mb-2" placeholder="Nombre Cliente">
       <select id="c-metodo" class="form-select mb-2" onchange="toggleIni()"><option>Contado</option><option>Cr√©dito</option></select>
       <input id="c-inicial" type="number" class="form-control mb-3" placeholder="Inicial" disabled style="display:none; background:#e9ecef;">
       <button class="btn btn-success w-100 fw-bold py-2" onclick="finalizarVenta()">‚úÖ CONFIRMAR VENTA</button>
    </div>
  </template>

  <div class="modal fade" id="modalProv"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body">
     <h6 class="fw-bold mb-3">üë• Gesti√≥n de Proveedores</h6>
     <div class="input-group mb-3"><input id="new-prov-name" class="form-control" placeholder="Nuevo Prov"><input id="new-prov-tel" class="form-control" placeholder="WhatsApp"><button class="btn btn-success" onclick="guardarProvManual()">üíæ</button></div>
     <div id="list-provs" style="max-height:300px; overflow-y:auto;"></div>
  </div></div></div></div>

  <div class="modal fade" id="modalEdicion"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body">
     <h6 class="fw-bold mb-3">Editar Producto</h6>
     <div class="mb-2"><label class="small fw-bold">Nombre</label><input id="inp-edit-nombre" class="form-control fw-bold"></div>
     <div class="row g-2 mb-2"><div class="col-6"><label class="small fw-bold">Categor√≠a</label><input list="list-cats" id="inp-edit-categoria" class="form-control"></div><div class="col-6"><label class="small fw-bold">Costo</label><input type="number" id="inp-edit-costo" class="form-control"></div></div>
     <div class="mb-2"><label class="small fw-bold">Proveedor</label><input id="inp-edit-proveedor" class="form-control"></div>
     <div class="mb-2"><label class="small fw-bold">Descripci√≥n</label><textarea id="inp-edit-desc" class="form-control"></textarea></div>
     <div class="mb-3 file-upload-wrapper"><input type="file" id="inp-file-foto" accept="image/*" onchange="previewFile()"><img id="img-preview-box" class="preview-img"><div class="placeholder-text"><div style="font-size:2rem;">üì∑</div><div>Subir Foto</div></div></div>
     <div class="d-grid gap-2"><button class="btn btn-dark" onclick="guardarCambiosAvanzado()">Guardar</button><button class="btn btn-outline-danger" onclick="eliminarProductoActual()">Eliminar</button></div>
  </div></div></div></div>

  <div class="modal fade" id="modalNuevo"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body">
     <h6 class="fw-bold mb-3">Nuevo Producto</h6>
     <form onsubmit="event.preventDefault(); crearProducto();"><div class="mb-2"><label class="small fw-bold">Nombre</label><input id="new-nombre" class="form-control" required></div><div class="row g-2 mb-2"><div class="col-6"><label class="small fw-bold">Categor√≠a</label><input list="list-cats" id="new-categoria" class="form-control" onchange="generarIDAuto()"></div><div class="col-6"><label class="small fw-bold">Costo</label><input type="number" id="new-costo" class="form-control"></div></div><div class="mb-2"><label class="small fw-bold">Proveedor</label><input id="new-proveedor" class="form-control"></div><div class="mb-3"><label class="small fw-bold">ID</label><input id="new-id" class="form-control bg-light" readonly></div><button type="submit" class="btn btn-primary w-100">Crear</button></form>
  </div></div></div></div>

  <div class="modal fade" id="modalWA"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body">
    <h6 class="fw-bold mb-3 text-success">Importar WhatsApp</h6>
    <input id="wa-prov" class="form-control mb-2" placeholder="Proveedor"><input list="list-cats" id="wa-cat" class="form-control mb-2" placeholder="Categor√≠a"><textarea id="wa-text" class="form-control mb-3" rows="5" placeholder="Pega el chat..."></textarea><button class="btn btn-success w-100" onclick="procesarWA()">Procesar</button>
  </div></div></div></div>

  <div class="modal fade" id="modalPed"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body"><h6 class="fw-bold">Nuevo Pedido</h6><input id="pe-prod" class="form-control mb-2" placeholder="Producto"><input id="pe-nota" class="form-control mb-2" placeholder="Notas"><button class="btn btn-dark w-100" onclick="savePed()">Solicitar</button></div></div></div></div>
  <datalist id="list-cats"></datalist>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const API_URL = "PEGAR_URL_DE_GOOGLE_AQUI"; // <--- PEGA TU URL AQUI

    var D = {inv:[], provs:[], deud:[], ped:[], hist:[], cats:[], proveedores:[]};
    var CART = [];
    var modalEdit, modalNuevo, modalWA, modalProv;
    var prodEdit = null;
    var calculatedValues = { total: 0, inicial: 0 };

    // --- CONEXI√ìN API (FETCH) ---
    async function callAPI(action, data = null) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: action, data: data })
        });
        const result = await response.json();
        return result;
      } catch (e) {
        alert("Error de conexi√≥n: " + e.toString());
        return { exito: false, error: e.toString() };
      }
    }

    window.onload = function() {
      modalEdit = new bootstrap.Modal('#modalEdicion');
      modalNuevo = new bootstrap.Modal('#modalNuevo');
      modalWA = new bootstrap.Modal('#modalWA');
      modalProv = new bootstrap.Modal('#modalProv');
      document.getElementById('desktop-cart-container').innerHTML = document.getElementById('tpl-cart').innerHTML;
      document.getElementById('mobile-cart').innerHTML = document.getElementById('tpl-cart').innerHTML;
      loadData();
    };

    function loadData(){
      callAPI('obtenerDatosCompletos').then(res => {
        D = res;
        D.inv = res.inventario || [];
        D.historial = res.historial || []; 
        D.proveedores = res.proveedores || [];
        document.getElementById('loader').style.display='none';
        document.getElementById('user-display').innerText = res.user;
        document.getElementById('bal-caja').innerText = '$'+res.metricas.saldo.toLocaleString();
        document.getElementById('bal-ventas').innerText = '$'+res.metricas.ventaMes.toLocaleString();
        document.getElementById('bal-ganancia').innerText = '$'+res.metricas.gananciaMes.toLocaleString();
        renderPos(); renderInv(); renderFin(); renderPed(); renderProvs();
        var dl = document.getElementById('list-cats'); dl.innerHTML='';
        res.categorias.forEach(c => { var o=document.createElement('option'); o.value=c; dl.appendChild(o); });
      });
    }

    function nav(v, btn){
      document.querySelectorAll('.view-sec').forEach(e => e.style.display='none');
      document.getElementById('view-'+v).style.display='block';
      document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
      btn.classList.add('active');
    }

    function renderPos(){
      var q = document.getElementById('pos-search').value.toLowerCase();
      var c = document.getElementById('pos-list'); c.innerHTML='';
      var lista = D.inv || [];
      var res = lista.filter(p => (p.nombre && p.nombre.toLowerCase().includes(q)) || (p.cat && p.cat.toLowerCase().includes(q)));
      if(res.length === 0) document.getElementById('msg-empty-pos').style.display = 'block'; else document.getElementById('msg-empty-pos').style.display = 'none';
      res.slice(0,40).forEach(p => {
        var active = CART.some(x=>x.id===p.id) ? 'active' : '';
        var src = (p.foto && p.foto.includes('http')) ? p.foto.replace('view','thumbnail') : '';
        var img = src ? `<img src="${src}" class="product-thumb">` : `<div class="product-thumb">üì∑</div>`;
        var priceTxt = p.costo > 0 ? `$${p.costo.toLocaleString()}` : '<small class="text-danger">Consultar</small>';
        var div = document.createElement('div'); div.className = `card-product d-flex align-items-center ${active}`;
        div.onclick = function() { toggleCart(p, div); };
        div.innerHTML = `<div class="check-mark">‚úì</div>${img}<div class="flex-grow-1" style="min-width:0;"><div class="fw-bold text-dark lh-1 mb-1 text-truncate">${p.nombre}</div><small class="text-muted d-block text-truncate">${p.prov}</small><div class="price-tag mt-1">${priceTxt}</div></div>`;
        c.appendChild(div);
      });
    }
    function toggleCart(p, el) {
       var idx = CART.findIndex(x=>x.id===p.id);
       if(idx > -1) { CART.splice(idx,1); el.classList.remove('active'); } else { CART.push(p); el.classList.add('active'); }
       updateCartUI();
    }
    function updateCartUI() {
       var count = CART.length; calcCart();
       var btnFloat = document.getElementById('btn-float-cart'); btnFloat.style.display = count > 0 ? 'block' : 'none'; btnFloat.innerText = "üõí " + count;
       var names = CART.map(x=>x.nombre).join(', '); document.querySelectorAll('#cart-items-list').forEach(e => e.innerText = names || 'Selecciona productos...');
    }
    function calcCart() {
       if(CART.length===0) { document.querySelectorAll('#res-cont').forEach(e => e.innerText = '$0'); return; }
       var isMobile = window.innerWidth < 992 && document.getElementById('mobile-cart').classList.contains('visible');
       var parent = isMobile ? document.getElementById('mobile-cart') : document.getElementById('desktop-cart-container');
       if(!parent) parent = document.getElementById('desktop-cart-container'); 
       var util = parseFloat(parent.querySelector('#c-util').value)||0;
       var inter = parseFloat(parent.querySelector('#c-int').value)||0;
       var cuotas = parseInt(parent.querySelector('#c-cuotas').value)||1;
       var conIva = parent.querySelector('#c-iva').checked;
       var metodo = parent.querySelector('#c-metodo').value;
       var totalCosto = CART.reduce((a,b)=>a+b.costo,0);
       var base = totalCosto * (1 + util/100);
       if(conIva) base = base * 1.19;
       document.querySelectorAll('#res-cont').forEach(e => e.innerText = '$'+Math.round(base).toLocaleString());
       calculatedValues.total = base;
       var rowCred = parent.querySelectorAll('#row-cred'); var inpInicial = parent.querySelectorAll('#c-inicial');
       if(metodo === "Cr√©dito") {
           var inicial = base * 0.30; calculatedValues.inicial = inicial;
           var saldoRestante = base - inicial; var saldoConInteres = saldoRestante * (1 + inter/100); var valorCuota = saldoConInteres / cuotas;
           rowCred.forEach(e => { e.style.display = 'block'; e.querySelector('#res-ini').innerText = '$'+Math.round(inicial).toLocaleString(); e.querySelector('#res-cuota-val').innerText = '$'+Math.round(valorCuota).toLocaleString(); e.querySelector('#res-cuota-txt').innerText = `x ${cuotas} cuotas`; });
           inpInicial.forEach(e => { e.value = Math.round(inicial); e.style.display='block'; });
       } else { rowCred.forEach(e => e.style.display = 'none'); inpInicial.forEach(e => e.style.display='none'); }
    }
    function toggleMobileCart() { document.getElementById('mobile-cart').classList.toggle('visible'); }
    function toggleIni() { calcCart(); } 
    function clearCart() { CART=[]; renderPos(); updateCartUI(); }
    function finalizarVenta() {
       if(CART.length===0) return alert("Carrito vac√≠o");
       var parent = (window.innerWidth < 992 && document.getElementById('mobile-cart').classList.contains('visible')) ? document.getElementById('mobile-cart') : document.getElementById('desktop-cart-container');
       var cli = parent.querySelector('#c-cliente').value;
       if(!cli) return alert("Falta Cliente");
       var metodo = parent.querySelector('#c-metodo').value;
       var factor = calculatedValues.total / CART.reduce((a,b)=>a+b.costo,0);
       var d = { items: CART.map(p => ({ nombre: p.nombre, cat: p.cat, costo: p.costo, precioVenta: p.costo * factor })), cliente: cli, metodo: metodo, inicial: (metodo === 'Cr√©dito') ? calculatedValues.inicial : 0, vendedor: D.user };
       document.getElementById('loader').style.display='flex';
       callAPI('procesarVentaCarrito', d).then(r => { if(r.exito) { location.reload(); } else { alert(r.error); document.getElementById('loader').style.display='none'; } });
    }
    function abrirModalProv() { renderProvs(); modalProv.show(); }
    function renderProvs() {
        var c = document.getElementById('list-provs'); c.innerHTML='';
        D.proveedores.forEach(p => {
            var waLink = p.tel ? `https://wa.me/57${p.tel.replace(/\D/g,'')}` : '#';
            var btn = p.tel ? `<a href="${waLink}" target="_blank" class="btn-wa-mini"><i class="fab fa-whatsapp"></i></a>` : '<span class="text-muted">-</span>';
            c.innerHTML += `<div class="prov-item"><div><strong>${p.nombre}</strong><br><small class="text-muted">${p.tel||'Sin numero'}</small></div><div class="d-flex gap-2">${btn}<button class="btn btn-sm btn-light border" onclick="editarProv('${p.nombre}')">‚úèÔ∏è</button></div></div>`;
        });
    }
    function guardarProvManual(){ var n = document.getElementById('new-prov-name').value; var t = document.getElementById('new-prov-tel').value; if(!n) return; callAPI('registrarProveedor', {nombre:n, tel:t}).then(r=>{ document.getElementById('new-prov-name').value=''; document.getElementById('new-prov-tel').value=''; loadData(); }); }
    function editarProv(nombre){ var t = prompt("Nuevo tel√©fono para "+nombre+":"); if(t) { callAPI('registrarProveedor', {nombre:nombre, tel:t}).then(()=>loadData()); } }
    function renderInv(){ var c=document.getElementById('inv-list');c.innerHTML=''; (D.inv||[]).forEach(p=>{c.innerHTML+=`<div class="card-k d-flex justify-content-between align-items-center" onclick='openEdit(${JSON.stringify(p)})'><div><strong>${p.nombre}</strong><br><small>${p.cat}</small></div><button class="btn btn-sm btn-light border">‚úèÔ∏è</button></div>`}); }
    function openEdit(p){ prodEdit=p; document.getElementById('inp-edit-nombre').value=p.nombre; document.getElementById('inp-edit-categoria').value=p.cat; document.getElementById('inp-edit-costo').value=p.costo; document.getElementById('inp-edit-proveedor').value=p.prov; document.getElementById('inp-edit-desc').value=p.desc; document.getElementById('img-preview-box').style.display='none'; if(p.foto){document.getElementById('img-preview-box').src=p.foto.replace('view','thumbnail');document.getElementById('img-preview-box').style.display='block';} modalEdit.show(); }
    function previewFile(){ var f=document.getElementById('inp-file-foto').files[0]; if(f){var r=new FileReader();r.onload=e=>{document.getElementById('img-preview-box').src=e.target.result;document.getElementById('img-preview-box').style.display='block';};r.readAsDataURL(f);} }
    function guardarCambiosAvanzado(){
       if(!prodEdit) return; var btn=document.querySelector('#modalEdicion .btn-dark'); var txt=btn.innerText;
       var d={id:prodEdit.id, nombre:document.getElementById('inp-edit-nombre').value, categoria:document.getElementById('inp-edit-categoria').value, proveedor:document.getElementById('inp-edit-proveedor').value, costo:document.getElementById('inp-edit-costo').value, descripcion:document.getElementById('inp-edit-desc').value, urlExistente:prodEdit.foto||""};
       var f=document.getElementById('inp-file-foto').files[0];
       var send=function(b64){ d.imagenBase64=b64; if(f){d.mimeType=f.type;d.nombreArchivo=f.name;} callAPI('guardarProductoAvanzado', d).then(r=>{btn.innerText=txt;btn.disabled=false;if(r.exito){modalEdit.hide();location.reload();}else alert(r.error)}); };
       if(f){ btn.innerText="Subiendo...";btn.disabled=true; var r=new FileReader(); r.onload=e=>send(e.target.result.split(',')[1]); r.readAsDataURL(f); } else { send(); }
    }
    function eliminarProductoActual(){ if(confirm("Eliminar?")){ callAPI('eliminarProductoBackend', prodEdit.id).then(r=>{if(r.exito)location.reload()}); } }
    function abrirModalNuevo(){ document.getElementById('new-id').value=''; modalNuevo.show(); }
    function generarIDAuto(){ var c=document.getElementById('new-categoria').value; if(c)document.getElementById('new-id').value=c.substring(0,3).toUpperCase()+'-'+Math.floor(Math.random()*9999); }
    function crearProducto(){ var d={nombre:document.getElementById('new-nombre').value, categoria:document.getElementById('new-categoria').value, proveedor:document.getElementById('new-proveedor').value, costo:document.getElementById('new-costo').value, id:document.getElementById('new-id').value||'GEN-'+Math.random()}; callAPI('crearProductoManual', d).then(r=>{if(r.exito){modalNuevo.hide();location.reload();}}); }
    function abrirModalWA(){ modalWA.show(); }
    function procesarWA(){ var p=document.getElementById('wa-prov').value,c=document.getElementById('wa-cat').value,t=document.getElementById('wa-text').value; if(!c||!t)return alert("Falta datos"); var btn=document.querySelector('#modalWA .btn-success'); btn.innerText="Procesando..."; btn.disabled=true; callAPI('procesarImportacionDirecta', {prov:p, cat:c, txt:t}).then(r=>{alert(r.mensaje||r.error);location.reload()}); }
    function renderFin(){ 
      var s=document.getElementById('ab-cli'); s.innerHTML='<option value="">Seleccione...</option>'; D.deudores.forEach(d=>{ s.innerHTML+=`<option value="${d.idVenta}">${d.cliente} ($${d.saldo.toLocaleString()})</option>`; });
      var h=document.getElementById('hist-list'); h.innerHTML=''; 
      var dataHist = D.historial || []; if(dataHist.length === 0) { h.innerHTML = '<div class="text-center text-muted p-3">Sin movimientos registrados.</div>'; } 
      else { dataHist.forEach(x=>{ var i=(x.tipo.includes('ingreso')||x.tipo.includes('abono')); h.innerHTML+=`<div class="mov-item d-flex align-items-center mb-2 p-2 border-bottom"><div class="mov-icon me-3 ${i?'text-success':'text-danger'}"><i class="fas fa-${i?'arrow-down':'arrow-up'}"></i></div><div class="flex-grow-1 lh-1"><div class="fw-bold small">${x.desc}</div><small class="text-muted" style="font-size:0.75rem">${x.fecha}</small></div><div class="fw-bold ${i?'text-success':'text-danger'}">${i?'+':'-'} $${x.monto.toLocaleString()}</div></div>`; }); }
    }
    function doAbono(){ var id=document.getElementById('ab-cli').value; if(!id)return; var txt=document.getElementById('ab-cli').options[document.getElementById('ab-cli').selectedIndex].text; var cli=txt.split('(')[0].trim(); document.getElementById('loader').style.display='flex'; callAPI('registrarAbono', {idVenta:id, monto:document.getElementById('ab-monto').value, cliente:cli}).then(()=>location.reload()); }
    function doGasto(){ var d={desc:document.getElementById('g-desc').value, cat:document.getElementById('g-cat').value, monto:document.getElementById('g-monto').value, vinculo:document.getElementById('g-vinculo').value}; document.getElementById('loader').style.display='flex'; callAPI('registrarGasto', d).then(()=>location.reload()); }
    function renderPed(){ var c=document.getElementById('ped-list'); c.innerHTML=''; D.ped.forEach(p=>{ c.innerHTML+=`<div class="card-k border-start border-4 ${p.estado==='Pendiente'?'border-warning':'border-success'}"><strong>${p.prod}</strong><br><small>${p.user} - ${p.fecha}</small></div>`}); }
    function savePed(){ var p=document.getElementById('pe-prod').value; if(!p)return; callAPI('guardarPedido', {user:D.user, prod:p, notas:document.getElementById('pe-nota').value}).then(()=>location.reload()); }
    function verBancos() { const num = "0090894825"; Swal.fire({title:'Bancolombia',text:num,icon:'info',confirmButtonText:'Copiar'}).then((r)=>{if(r.isConfirmed)navigator.clipboard.writeText(num)}); }
  </script>
</body>
</html>
