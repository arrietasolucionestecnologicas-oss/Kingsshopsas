<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Kingshop POS | Sistema de Gesti√≥n Comercial</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/png" href="icon-192.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <style>
    /* --- TEMA PREMIUM: KING'S SHOP BLACK & GOLD --- */
    :root { 
        --primary: #000000;      /* Negro Puro */
        --gold: #d4af37;         /* Dorado Premium */
        --gold-hover: #b59020;   /* Dorado Oscuro */
        --light: #f8f9fa;        /* Gris suave */
        --dark: #212529;         /* Texto oscuro */
        --bg: #f4f4f9;
        --s: #2ecc71; /* Verde √©xito */
        --d: #e74c3c; /* Rojo error */
    }

    body { 
        background: var(--bg); 
        padding-bottom: 90px; 
        font-family: 'Montserrat', sans-serif; 
        overflow-x: hidden; 
        color: var(--dark); 
    }

    /* HEADER */
    .header { 
        background-color: var(--primary); 
        color: white; 
        padding: 15px 20px; 
        border-radius: 0 0 20px 20px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.4); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        border-bottom: 2px solid var(--gold);
    }

    /* INDICADOR OFFLINE */
    #offline-indicator {
        background-color: #ffc107;
        color: #000;
        text-align: center;
        padding: 5px;
        font-size: 0.8rem;
        font-weight: bold;
        display: none; /* Se activa con JS */
    }

    /* LAYOUT VENTAS */
    .main-layout { display: flex; gap: 20px; align-items: flex-start; padding: 15px; }
    .list-column { flex: 1; }
    .panel-column { width: 350px; position: sticky; top: 10px; display: none; } 
    @media (min-width: 992px) { .panel-column { display: block; } }

    /* --- ESTILO VENTA: LISTA COMPACTA (POS) --- */
    .pos-row-lite {
        background: white;
        padding: 12px 15px;
        margin-bottom: 8px;
        border-radius: 8px;
        border-left: 5px solid transparent;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        cursor: pointer;
        display: flex; justify-content: space-between; align-items: center;
        transition: 0.1s;
    }
    .pos-row-lite:hover { transform: translateX(3px); border-left-color: var(--gold); }
    .pos-row-lite.active { border-left-color: var(--gold); background: #fffcf5; border-right: 1px solid var(--gold); }
    
    .pos-row-lite .info { flex: 1; }
    .pos-row-lite .name { font-weight: 700; color: var(--primary); font-size: 0.95rem; margin-bottom: 2px; }
    .pos-row-lite .meta { font-size: 0.75rem; color: #888; }
    .pos-row-lite .price { font-weight: 700; font-size: 1.1rem; color: var(--gold-hover); text-align: right; min-width: 80px; }
    
    /* --- ESTILO CAT√ÅLOGO: GRID (STOCK) --- */
    .catalog-grid {
        display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
    }
    @media (min-width: 768px) {
        .catalog-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
    }

    .card-catalog {
        background: white; border-radius: 12px; overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #eee;
        display: flex; flex-direction: column;
        transition: 0.2s;
    }
    .card-catalog:hover { border-color: var(--gold); box-shadow: 0 5px 15px rgba(212, 175, 55, 0.15); }

    .cat-img-box {
        height: 120px; width: 100%; background: #f8f9fa;
        display: flex; align-items: center; justify-content: center;
        overflow: hidden; border-bottom: 1px solid #eee; position: relative;
    }
    .cat-img-box img { width: 100%; height: 100%; object-fit: cover; }
    
    /* Bot√≥n Editar Flotante */
    .btn-edit-float {
        position: absolute; top: 5px; right: 5px;
        background: rgba(255,255,255,0.95); border-radius: 50%;
        width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; color: var(--primary); font-size: 0.8rem;
        border: 1px solid transparent;
    }
    .btn-edit-float:hover { color: var(--gold); border-color: var(--gold); }

    .cat-body { padding: 10px; flex: 1; display: flex; flex-direction: column; }
    .cat-title { font-weight: 700; font-size: 0.85rem; line-height: 1.2; margin-bottom: 5px; color: var(--primary); height: 34px; overflow: hidden; }
    .cat-price { color: var(--gold-hover); font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; }
    
    .cat-actions { 
        background: #fcfcfc; padding: 5px; 
        display: flex; justify-content: space-around; gap: 2px;
        border-top: 1px solid #eee;
    }
    .btn-copy-mini {
        border: 1px solid #ddd; background: white; color: #555;
        border-radius: 4px; padding: 2px 0; width: 100%;
        font-size: 0.7rem; text-align: center; cursor: pointer; transition: 0.2s;
    }
    .btn-copy-mini:hover { background: var(--primary); color: var(--gold); border-color: var(--primary); }

    /* PANEL COTIZADOR */
    .cotizador-panel { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .input-line { border:none; border-bottom: 2px solid #eee; width:100%; text-align:center; font-weight:bold; outline:none; color: var(--primary); }

    /* PANEL MOVIL */
    .mobile-panel { position: fixed; bottom: 0; left: 0; width: 100%; background: white; z-index: 5000; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -5px 30px rgba(0,0,0,0.3); transform: translateY(110%); transition: transform 0.3s; }
    .mobile-panel.visible { transform: translateY(0); }

    .card-k { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: none; }
    
    .card-balance { 
        padding: 25px; color: var(--gold); 
        border-radius: 20px; text-align: center; 
        background: linear-gradient(135deg, #1a1a1a, #000000); 
        box-shadow: 0 4px 15px rgba(0,0,0,0.4); 
        margin-bottom: 15px; border: 1px solid var(--gold); 
    }
    .card-balance h1 { color: white; }

    /* SCROLL HORIZONTAL */
    .scroll-menu {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding-bottom: 5px;
        margin-bottom: 15px;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch; 
    }
    .scroll-menu::-webkit-scrollbar { display: none; }
    .scroll-menu > * { flex: 0 0 auto; }

    .nav-btm { 
        position: fixed; bottom: 0; width: 100%; background: white; 
        display: flex; justify-content: space-between; 
        padding: 8px 10px; border-top: 1px solid #eee; z-index: 1000; 
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    .nav-btn { 
        background: none; border: none; color: #aaa; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        font-size: 0.7rem; flex: 1; transition: 0.2s;
    }
    .nav-btn i { font-size: 1.3rem; margin-bottom: 3px; }
    .nav-btn span { font-weight: 500; }
    .nav-btn.active { color: var(--gold); transform: translateY(-2px); }
    .nav-btn.active span { font-weight: 700; color: var(--primary); }

    .file-upload-wrapper { position: relative; width: 100%; height: 200px; border: 2px dashed #ccc; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fafafa; overflow: hidden; }
    .preview-img { position: absolute; width: 100%; height: 100%; object-fit: contain; z-index: 5; display: none; background: white; }
    .file-input-overlay { position: absolute; top:0; left:0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 100; }
    .placeholder-text { z-index: 1; pointer-events: none; }

    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }

    .btn-bi { background: rgba(255,255,255,0.1); border:1px solid rgba(212, 175, 55, 0.5); color:var(--gold); border-radius: 8px; padding: 5px 10px; font-size: 0.8rem; text-decoration: none; transition: 0.2s; }
    .btn-bi:hover { background: var(--gold); color: var(--primary); border-color: var(--gold); }

    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }

    .prov-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .prov-item:last-child { border-bottom: none; }
    .btn-wa-mini { background: #25D366; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; text-decoration: none; }

    .btn-xs { padding: 2px 8px; font-size: 0.75rem; border-radius: 4px; }
    .card-debt { border-left: 4px solid var(--d); position: relative; }
    .card-debt .badge-debt { background: var(--d); color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; }

    /* OVERRIDES BOOTSTRAP */
    .btn-primary, .btn-dark { background-color: var(--primary) !important; border-color: var(--primary) !important; color: white !important; }
    .btn-primary:hover, .btn-dark:hover { background-color: #333 !important; border-color: #333 !important; color: var(--gold) !important; }
    
    .btn-info { background-color: var(--gold) !important; border-color: var(--gold) !important; color: var(--primary) !important; font-weight: bold; }
    .btn-info:hover { background-color: var(--gold-hover) !important; border-color: var(--gold-hover) !important; }

    .text-primary { color: var(--primary) !important; }
    .text-success { color: #198754 !important; } 
    
    #btn-float-cart { background-color: var(--gold); color: var(--primary); border: none; }
    .form-control:focus { box-shadow: 0 0 0 2px var(--gold) !important; border-color: var(--gold) !important; }
    
    .nav-pills .nav-link.active { background-color: var(--primary) !important; color: var(--gold) !important; }
    .nav-pills .nav-link { color: var(--primary) !important; }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner-border text-dark" role="status"></div><h6 class="mt-3 text-muted fw-bold">Conectando al Servidor Central...</h6></div>
  
  <div id="toast-container"></div>

  <div class="header">
    <div><h4 class="m-0 fw-bold" style="color: var(--gold); letter-spacing: 1px;">üëë KING'S SHOP POS</h4><small class="opacity-75" id="user-display">Verificando Credenciales...</small></div>
    <div class="d-flex gap-2">
        <a class="btn-bi" href="dashboard.html"><i class="bi bi-graph-up-arrow"></i> Reportes</a>
        <button class="btn btn-light shadow-sm rounded-circle" style="width:45px; height:45px; color: var(--primary);" onclick="verBancos()" title="Ver Cuentas Bancarias"><i class="bi bi-bank2 fs-5"></i></button>
    </div>
  </div>
  
  <div id="offline-indicator">‚ö†Ô∏è Modo Sin Conexi√≥n - Operando Localmente</div>

  <div class="container-fluid px-3">
    <div id="view-pos" class="view-sec">
      <div class="main-layout">
        <div class="list-column">
           <button class="btn btn-warning w-100 mb-2 fw-bold" onclick="agregarItemManual()"><i class="fas fa-plus"></i> AGREGAR √çTEM MANUAL (NO CATALOGADO)</button>
           
           <div class="bg-white p-2 rounded mb-3 shadow-sm d-flex align-items-center border" style="border-color: #eee;">
               <i class="fas fa-search text-muted ms-2 me-2"></i>
               <input type="text" id="pos-search" class="form-control border-0 shadow-none" placeholder="Buscar producto en inventario..." onkeyup="renderPos()" style="font-weight:bold;">
           </div>
           
           <div id="pos-placeholder" class="text-center text-muted py-5">
               <i class="fas fa-keyboard fs-1 mb-2 opacity-50" style="color: var(--gold);"></i>
               <p>Inicie la b√∫squeda para agregar<br>productos al carrito de venta.</p>
           </div>

           <div id="pos-list"></div>
        </div>
        <div class="panel-column"><div id="desktop-cart-container"></div></div>
      </div>
    </div>

    <div id="view-inv" class="view-sec" style="display:none; padding:15px;">
      <div class="scroll-menu">
        <input type="text" id="inv-search" class="form-control" placeholder="üîç Buscar Referencia..." onkeyup="renderInv()" style="width: 150px;">
        <select id="filter-prov" class="form-select" style="width: 150px; border-color: var(--gold);" onchange="renderInv()">
            <option value="">Todos los Proveedores</option>
        </select>
        <button class="btn btn-primary" onclick="abrirModalNuevo()" style="white-space: nowrap;">+ CREAR PRODUCTO</button>
        <button class="btn btn-info" onclick="abrirModalProv()" title="Gestionar Proveedores" style="white-space: nowrap;"><i class="fas fa-users"></i> Proveedores</button>
        <button class="btn btn-success" onclick="abrirModalWA()" title="Importar desde Chat" style="white-space: nowrap;"><i class="fab fa-whatsapp"></i> Importar Chat</button>
      </div>
      <div id="inv-list" class="catalog-grid"></div>
    </div>

    <div id="view-web" class="view-sec" style="display:none; padding:15px;">
        <h5 class="fw-bold mb-3 text-primary"><i class="fas fa-globe" style="color: var(--gold);"></i> Administraci√≥n Tienda Web</h5>
        <input type="text" id="web-search" class="form-control mb-3" placeholder="üîç Filtrar productos publicados..." onkeyup="renderWeb()">
        <div id="web-list"></div>
    </div>

    <div id="view-ped" class="view-sec" style="display:none; padding:15px;">
      <button class="btn btn-primary w-100 mb-3" onclick="abrirModalPed()">+ Registrar Nuevo Pedido a Proveedor</button>
      <div id="ped-list"></div>
    </div>

    <div id="view-cartera" class="view-sec" style="display:none; padding:15px;">
        <div class="card-balance" style="background: linear-gradient(135deg, #e74c3c, #c0392b); border-color: #a93226;">
            <small class="opacity-75" style="color:white;">Cuentas por Cobrar (Total Deuda)</small>
            <h1 class="fw-bold display-4 my-1" id="bal-cartera">...</h1>
        </div>
        <h6 class="fw-bold text-muted mb-3">Cartera de Clientes Activa</h6>
        <div id="cartera-list"></div>
    </div>

    <div id="view-fin" class="view-sec" style="display:none; padding:15px;">
      
      <div class="card-k mb-3" style="border: 2px dashed var(--gold);">
          <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-bold m-0"><i class="fas fa-check-double"></i> Conciliaci√≥n de Caja (Auditor√≠a)</h6>
              <span id="audit-res" class="small"></span>
          </div>
          <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="audit-banco" class="form-control" placeholder="Ingrese Saldo Real (Bancos + Efectivo)">
              <button class="btn btn-dark" onclick="verificarBanco()">Auditar</button>
          </div>
      </div>

      <div class="card-balance">
          <small class="opacity-75">Flujo de Caja Disponible (Sistema)</small>
          <h1 class="fw-bold display-4 my-1" id="bal-caja">...</h1>
      </div>
      <div class="row g-2 mb-3">
         <div class="col-6"><div class="card-k p-2 text-center h-100"><small class="text-muted">Ventas Brutas Mes</small><h6 class="fw-bold mb-0" id="bal-ventas" style="color: var(--primary);">...</h6></div></div>
         <div class="col-6"><div class="card-k p-2 text-center h-100"><small class="text-muted">Utilidad Neta Mes</small><h6 class="fw-bold text-success mb-0" id="bal-ganancia">...</h6></div></div>
      </div>
      <ul class="nav nav-pills nav-fill mb-3 bg-white rounded shadow-sm p-1">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#f-abono">Registrar Pago</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#f-ingreso">Inyecci√≥n Capital</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#f-gasto">Registrar Egreso</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#f-hist">Movimientos</a></li>
      </ul>
      <div class="tab-content">
         <div class="tab-pane fade show active" id="f-abono">
            <div class="card-k">
               <h6 class="text-success fw-bold">Abono a Deuda (Recaudo)</h6>
               <select id="ab-cli" class="form-select mb-2"></select>
               <input type="number" id="ab-monto" class="form-control mb-2" placeholder="Monto Recibido">
               <label class="small text-muted fw-bold">Fecha del Pago:</label>
               <input type="date" id="ab-fecha" class="form-control mb-2" style="border-color: var(--gold);">
               
               <button class="btn btn-success w-100" onclick="doAbono()">CONFIRMAR RECAUDO</button>
            </div>
         </div>
         
         <div class="tab-pane fade" id="f-ingreso">
            <div class="card-k">
               <h6 class="fw-bold" style="color: var(--primary);">Entrada de Dinero Extraordinaria</h6>
               <input type="text" id="inc-desc" class="form-control mb-2" placeholder="Concepto (Ej: Pr√©stamo Bancario, Inversi√≥n)">
               <select id="inc-cat" class="form-select mb-2">
                   <option value="Venta Externa">Venta Externa</option>
                   <option value="Prestamo">Pr√©stamo / Financiaci√≥n</option>
                   <option value="Inyeccion Capital">Aporte de Capital</option>
                   <option value="Otros">Otros Ingresos</option>
               </select>
               <input type="number" id="inc-monto" class="form-control mb-2" placeholder="Monto Ingresado">
               <button class="btn btn-primary w-100" onclick="doIngresoExtra()">REGISTRAR ENTRADA</button>
            </div>
         </div>

         <div class="tab-pane fade" id="f-gasto">
            <div class="card-k">
               <h6 class="text-danger fw-bold">Salida de Dinero (Gasto/Costo)</h6>
               <input type="text" id="g-desc" class="form-control mb-2" placeholder="Concepto del Egreso">
               <select id="g-cat" class="form-select mb-2"><option>Transporte / Log√≠stica</option><option>Alimentaci√≥n</option><option>Costo Mercancia (Inventario)</option><option>Servicios P√∫blicos</option><option>N√≥mina</option><option>Otros Gastos</option></select>
               <input type="number" id="g-monto" class="form-control mb-2" placeholder="Valor Pagado">
               
               <label class="small text-muted fw-bold mt-2">Vincular a Operaci√≥n (Correcci√≥n de Costos):</label>
               <input list="g-vinculo-list" id="g-vinculo" class="form-control mb-2 border-warning" style="border: 1px solid #ffc107;" placeholder="üîç Escribe para buscar (Venta o Producto)...">
               
               <small class="d-block mb-3 text-muted" style="font-size: 0.75rem;">
                   * Si vinculas a una <b>Venta</b>, se recalcular√° su utilidad real.<br>
                   * Si vinculas a un <b>Producto</b>, se actualizar√° su costo base en inventario.
               </small>
               
               <button class="btn btn-danger w-100" onclick="doGasto()">REGISTRAR EGRESO</button>
            </div>
         </div>
         
         <div class="tab-pane fade" id="f-hist">
             <div class="card-k">
                 <input type="text" id="hist-search" class="form-control mb-3" placeholder="üîç Buscar movimiento por nombre..." onkeyup="renderFin()">
                 <div id="hist-list"></div>
             </div>
         </div>
      </div>
    </div>
  </div>

  <div id="mobile-cart" class="mobile-panel"></div>
  <button id="btn-float-cart" class="btn shadow" style="position:fixed; bottom:80px; right:20px; width:60px; height:60px; z-index:4000; display:none; font-size:1.5rem;" onclick="toggleMobileCart()" title="Ver Carrito">üõí</button>

  <div class="nav-btm">
    <button class="nav-btn active" onclick="nav('pos',this)">
        <i class="fas fa-cash-register"></i>
        <span>Punto Venta</span>
    </button>
    <button class="nav-btn" onclick="nav('inv',this)">
        <i class="fas fa-box-open"></i>
        <span>Inventario</span>
    </button>
    <button class="nav-btn" onclick="nav('cartera',this)">
        <i class="fas fa-hand-holding-usd text-danger"></i>
        <span class="text-danger">Cobranza</span>
    </button>
    <button class="nav-btn" onclick="nav('ped',this)">
        <i class="fas fa-shipping-fast"></i>
        <span>Compras</span>
    </button>
    <button class="nav-btn" onclick="nav('fin',this)">
        <i class="fas fa-chart-pie"></i>
        <span>Finanzas</span>
    </button>
    <button class="nav-btn" onclick="nav('web',this)">
        <i class="fas fa-cloud" style="color: var(--primary);"></i>
        <span style="color: var(--primary);">E-Comm</span>
    </button>
  </div>

  <template id="tpl-cart">
    <div class="cotizador-panel">
       <div class="d-flex justify-content-between mb-2 align-items-center">
         <h5 class="fw-bold m-0" style="color: var(--primary);">Resumen de Operaci√≥n</h5>
         <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">üóëÔ∏è Vaciar</button>
       </div>
       
       <input id="c-concepto" class="form-control mb-2 fw-bold" placeholder="üìù Descripci√≥n del √≠tem no catalogado..." style="display:none; border-left:4px solid var(--gold);">

       <div class="d-flex justify-content-between gap-2 mb-2" style="display:none !important;"> 
         <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="c-iva" onchange="calcCart()"><label class="form-check-label small fw-bold" for="c-iva">Aplicar IVA 19%</label></div>
         <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="c-manual" onchange="toggleManual()"><label class="form-check-label small fw-bold" for="c-manual">Precio Base Manual</label></div>
       </div>
       
       <div id="cart-items-list" class="mb-3 mt-2" style="max-height:150px; overflow-y:auto;">No hay √≠tems seleccionados...</div>
       
       <div class="row g-2 mb-3">
         <div class="col-3 text-center"><small>Margen %</small><input id="c-util" type="number" class="input-line" value="30" oninput="calcCart()"></div>
         <div class="col-3 text-center"><small>Desc. $</small><input id="c-desc" type="number" class="input-line text-danger" value="0" oninput="calcCart()"></div>
         <div class="col-3 text-center"><small>Tasa Int.%</small><input id="c-int" type="number" class="input-line" value="5" oninput="calcCart()"></div>
         <div class="col-3 text-center"><small>Plazo (M)</small><input id="c-cuotas" type="number" class="input-line" value="1" oninput="calcCart()"></div>
       </div>
       
       <label class="small fw-bold text-muted mt-2">Fecha de Registro:</label>
       <input type="date" id="c-fecha" class="form-control mb-3" style="border-color: var(--gold);">

       <div class="alert alert-light border text-center py-2 mb-3" style="background-color: #fffcf5; border-color: var(--gold) !important;">
          <div id="row-descuento" style="display:none; color: #e74c3c; font-size: 0.85rem; margin-bottom: 5px;">
              <div class="d-flex justify-content-between"><span>Descuento:</span><strong id="res-desc-val">-$0</strong></div>
          </div>
          
          <div class="d-flex justify-content-between align-items-center">
             <span>Valor Total Venta:</span>
             <div class="text-end">
                <strong id="res-cont" class="fs-5" style="color: var(--primary);">$0</strong>
                <input id="res-cont-input" type="number" class="form-control form-control-sm fw-bold text-end" style="display:none; color: var(--primary); border-color: var(--gold);" placeholder="Monto Base ($)" oninput="calcCart()">
             </div>
          </div>
          <div id="row-cred" style="display:none; border-top:1px dashed var(--gold); margin-top:5px; padding-top:5px;">
             <div class="d-flex justify-content-between" style="color: var(--primary);"><span>Cuota Inicial (30%):</span><strong id="res-ini">$0</strong></div>
             <div class="d-flex justify-content-between mt-1" style="color: var(--gold-hover);"><span>Saldo a Financiar:</span><strong id="res-cuota-val">$0</strong> <small id="res-cuota-txt">/ mes</small></div>
          </div>
          
          <div class="mt-2 text-end" style="border-top: 1px dotted #ccc; padding-top:5px;">
             <small class="text-muted" style="font-size:0.7rem;">Anular intereses (Precio Fijo Manual)</small>
             <input id="c-target" type="number" class="form-control form-control-sm fw-bold text-end" style="border-color: var(--gold); background: #fffffa;" placeholder="üí≤ Precio Final Pactado" oninput="calcCart()">
          </div>
       </div>
       
       <input id="c-cliente" class="form-control mb-2" placeholder="Nombre del Cliente / Raz√≥n Social">
       
       <div class="text-end mb-2">
          <a href="#" onclick="toggleDatosFormales(); return false;" class="small text-muted" style="text-decoration: none;">‚öôÔ∏è A√±adir datos formales (NIT, Tel)</a>
       </div>
       <div id="box-datos-formales" style="display:none; background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #ddd;">
          <input id="c-nit" class="form-control form-control-sm mb-2" placeholder="NIT / C√©dula">
          <input id="c-tel" class="form-control form-control-sm" placeholder="Tel√©fono / WhatsApp">
       </div>

       <select id="c-metodo" class="form-select mb-2" onchange="toggleIni()"><option value="Contado">Pago de Contado</option><option value="Cr√©dito">Venta a Cr√©dito</option></select>
       <input id="c-inicial" type="number" class="form-control mb-3" placeholder="Monto Inicial Personalizado" disabled style="display:none; background:#e9ecef;">
       
       <div class="d-flex gap-2">
           <button class="btn btn-dark flex-fill fw-bold text-white" onclick="generarCotizacionPDF()" title="Generar PDF Formal">üìÑ PDF</button>
           <button class="btn btn-success flex-fill fw-bold" onclick="shareQuote()"><i class="fab fa-whatsapp"></i> WSP</button>
           <button class="btn btn-primary flex-fill fw-bold" onclick="finalizarVenta()">‚úÖ VENDER</button>
       </div>
    </div>
  </template>

  <div class="modal fade" id="modalProv" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body"><h6 class="fw-bold mb-3" style="color: var(--primary);">üë• Directorio de Proveedores</h6><div class="input-group mb-3"><input id="new-prov-name" class="form-control" placeholder="Nombre Empresa/Prov"><input id="new-prov-tel" class="form-control" placeholder="Tel√©fono/WhatsApp"><button class="btn btn-primary" onclick="guardarProvManual()">üíæ Guardar</button></div><div id="list-provs" style="max-height:300px; overflow-y:auto;"></div></div></div></div></div>

  <div class="modal fade" id="modalEdicion" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h6 class="fw-bold mb-3" style="color: var(--primary);">Modificar Producto</h6>
                <div class="mb-2"><label class="small fw-bold">Nombre del Producto</label><input id="inp-edit-nombre" class="form-control fw-bold" style="color: var(--primary);"></div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small fw-bold">Categor√≠a</label>
                        <input list="list-cats" id="inp-edit-categoria" class="form-control">
                    </div>
                    <div class="col-6"><label class="small fw-bold">Costo Unitario</label><input type="number" id="inp-edit-costo" class="form-control" oninput="calcGain('inp-edit-costo','inp-edit-publico')"></div>
                </div>
                <div class="mb-2 p-2 bg-light border rounded" style="border-color: var(--gold) !important;">
                    <label class="small fw-bold" style="color: var(--primary);">Precio P√∫blico Sugerido (+30%)</label>
                    <input type="number" id="inp-edit-publico" class="form-control" placeholder="0 = Auto-c√°lculo" style="border-color: var(--gold); color: var(--primary); font-weight: bold;">
                </div>

                <div class="mb-2"><label class="small fw-bold">Proveedor Asignado</label><input id="inp-edit-proveedor" class="form-control"></div>
                <div class="mb-2"><label class="small fw-bold">Ficha T√©cnica / Descripci√≥n</label><textarea id="inp-edit-desc" class="form-control"></textarea></div>
                
                <div class="p-3 bg-light rounded border my-3">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="inp-edit-web" style="cursor:pointer;">
                        <label class="form-check-label fw-bold small" for="inp-edit-web" style="color: var(--primary);">üåê Publicar en Tienda Online</label>
                    </div>
                    <label class="small fw-bold" style="color: var(--primary);">Secci√≥n E-Commerce:</label>
                    <select id="inp-edit-cat-web" class="form-select form-select-sm" style="border-color: var(--primary);">
                        <option value="tecnologia">Tecnolog√≠a</option>
                        <option value="electro">Hogar y Electrodom√©sticos</option>
                        <option value="Gadget y Novedades">Gadgets y Novedades</option>
                        <option value="juguetes">Juguetes</option>
                        <option value="perfumes">Perfumes</option>
                    </select>
                </div>

                <div class="mb-3 file-upload-wrapper">
                    <input type="file" id="inp-file-foto" accept="image/*" onchange="previewFile()" class="file-input-overlay">
                    <img id="img-preview-box" class="preview-img">
                    <div class="placeholder-text text-center text-muted">
                        <div style="font-size:2rem; color: var(--gold);">üì∑</div>
                        <div>Tocar para actualizar imagen</div>
                    </div>
                </div>

                <div class="d-grid gap-2"><button class="btn btn-primary" onclick="guardarCambiosAvanzado()">Guardar Cambios</button><button class="btn btn-outline-danger" onclick="eliminarProductoActual()">Eliminar del Sistema</button></div>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalNuevo" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h6 class="fw-bold mb-3" style="color: var(--primary);">Alta de Nuevo Producto</h6>
                <form onsubmit="event.preventDefault(); crearProducto();">
                    <div class="mb-2"><label class="small fw-bold">Nombre del √çtem</label><input id="new-nombre" class="form-control" required></div>
                    <div class="row g-2 mb-2">
                        <div class="col-6"><label class="small fw-bold">Categor√≠a</label><input list="list-cats" id="new-categoria" class="form-control" onchange="generarIDAuto()"></div>
                        <div class="col-6"><label class="small fw-bold">Costo Base</label><input type="number" id="new-costo" class="form-control" oninput="calcGain('new-costo','new-publico')"></div>
                    </div>
                    <div class="mb-2 p-2 bg-light border rounded" style="border-color: var(--gold) !important;">
                        <label class="small fw-bold" style="color: var(--primary);">Precio Venta (+30% Auto)</label>
                        <input type="number" id="new-publico" class="form-control" style="border-color: var(--gold); color: var(--primary); font-weight: bold;">
                    </div>

                    <div class="mb-2"><label class="small fw-bold">Proveedor</label><input id="new-proveedor" class="form-control"></div>
                    <div class="mb-2"><label class="small fw-bold">Detalles / Specs</label><textarea id="new-desc" class="form-control"></textarea></div>
                    <div class="mb-3"><label class="small fw-bold">C√≥digo SKU (Generado)</label><input id="new-id" class="form-control bg-light" readonly></div>

                    <div class="p-3 bg-light rounded border my-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="new-web" style="cursor:pointer;">
                            <label class="form-check-label fw-bold small" for="new-web" style="color: var(--primary);">üåê Visible en Web</label>
                        </div>
                        <label class="small fw-bold" style="color: var(--primary);">Categor√≠a Online:</label>
                        <select id="new-cat-web" class="form-select form-select-sm" style="border-color: var(--primary);">
                            <option value="tecnologia">Tecnolog√≠a</option>
                            <option value="electro">Hogar y Electrodom√©sticos</option>
                            <option value="Gadget y Novedades">Gadgets y Novedades</option>
                            <option value="juguetes">Juguetes</option>
                            <option value="perfumes">Perfumes</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold">Imagen del Producto:</label>
                        <input type="file" id="new-file-foto" accept="image/*" class="form-control">
                    </div>

                    <button type="submit" class="btn btn-primary w-100" style="color: var(--gold);">Confirmar Creaci√≥n</button>
                </form>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalWA" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body"><h6 class="fw-bold mb-3 text-success">Importaci√≥n Masiva desde WhatsApp</h6><p class="small text-muted">Pega el texto del chat con la lista de precios para crear productos autom√°ticamente.</p><input id="wa-prov" class="form-control mb-2" placeholder="Nombre Proveedor"><input list="list-cats" id="wa-cat" class="form-control mb-2" placeholder="Categor√≠a Asignada"><textarea id="wa-text" class="form-control mb-3" rows="5" placeholder="Pegar texto aqu√≠..."></textarea><button class="btn btn-success w-100" onclick="procesarWA()">Procesar Texto</button></div></div></div></div>

  <div class="modal fade" id="modalPed" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h6 class="fw-bold" style="color: var(--primary);">Generar Solicitud de Compra</h6>
                <label class="small fw-bold">Producto Requerido *</label>
                <input list="list-prods-all" id="pe-prod" class="form-control mb-2" placeholder="Buscar o escribir nombre...">
                <label class="small fw-bold">Proveedor Destino</label>
                <input id="pe-prov" class="form-control mb-2" placeholder="Nombre Proveedor">
                <label class="small fw-bold">Presupuesto Estimado (Opcional)</label>
                <input type="number" id="pe-costo" class="form-control mb-2" placeholder="$">
                <label class="small fw-bold">Observaciones</label>
                <input id="pe-nota" class="form-control mb-2" placeholder="Especificaciones, colores, etc...">
                <button class="btn btn-primary w-100" onclick="savePed()">Crear Orden</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalEditPed" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h6 class="fw-bold" style="color: var(--primary);">Modificar Orden de Compra</h6>
                <label class="small fw-bold">Producto</label>
                <input list="list-prods-all" id="ed-ped-prod" class="form-control mb-2">
                <label class="small fw-bold">Proveedor</label>
                <input id="ed-ped-prov" class="form-control mb-2">
                <label class="small fw-bold">Costo Proyectado</label>
                <input type="number" id="ed-ped-costo" class="form-control mb-2">
                <label class="small fw-bold">Notas Adicionales</label>
                <input id="ed-ped-nota" class="form-control mb-2">
                <button class="btn btn-primary w-100" onclick="guardarEdicionPed()">Actualizar Orden</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalEditMov" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h6 class="fw-bold mb-3" style="color: var(--primary);">‚úèÔ∏è Ajuste Contable (Correcci√≥n)</h6>
                <p class="small text-muted">‚ö†Ô∏è Advertencia: Modificar transacciones pasadas afectar√° el balance general y los estados de cuenta.</p>
                
                <label class="small fw-bold">Concepto Original</label>
                <input id="ed-mov-desc" class="form-control mb-2" disabled style="background-color: #e9ecef;">
                
                <label class="small fw-bold">Fecha Contable Real</label>
                <input type="date" id="ed-mov-fecha" class="form-control mb-2" style="border-color: var(--gold);">
                
                <label class="small fw-bold">Monto Corregido</label>
                <input type="number" id="ed-mov-monto" class="form-control mb-3" style="font-weight: bold; color: var(--primary);">
                
                <button class="btn btn-warning w-100 fw-bold" onclick="guardarEdicionMovimiento()">Aplicar Correcci√≥n</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalRefinanciar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h6 class="fw-bold mb-3" style="color: var(--primary);">üîÑ Refinanciar Deuda</h6>
                
                <label class="small fw-bold text-muted">Cliente</label>
                <input id="ref-cliente" class="form-control mb-2 bg-light" readonly>
                
                <label class="small fw-bold text-muted">Saldo Actual</label>
                <input id="ref-saldo-actual" class="form-control mb-3 bg-light text-danger fw-bold" readonly>
                
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small fw-bold">Cargo Adicional / Mora ($)</label>
                        <input type="number" id="ref-cargo" class="form-control border-warning" value="0" oninput="calcRefinanciamiento()">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold">Nuevas Cuotas</label>
                        <input type="number" id="ref-cuotas" class="form-control" value="1" min="1" oninput="calcRefinanciamiento()">
                    </div>
                </div>
                
                <label class="small fw-bold">Nueva Fecha de Pago</label>
                <input type="date" id="ref-fecha" class="form-control mb-3 border-primary">
                
                <div class="alert alert-light border border-primary text-center">
                    <small class="d-block text-muted">Proyecci√≥n Nuevo Acuerdo:</small>
                    <div class="d-flex justify-content-between mt-2">
                        <span>Nuevo Saldo:</span>
                        <strong id="ref-nuevo-saldo" class="text-danger">$0</strong>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <span>Nueva Cuota:</span>
                        <strong id="ref-nueva-cuota" class="text-primary">$0 / mes</strong>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-secondary w-50" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary w-50 fw-bold" onclick="procesarRefinanciamiento()">Guardar Acuerdo</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <datalist id="list-cats"></datalist>
  <datalist id="list-prods-all"></datalist>
  <datalist id="g-vinculo-list"></datalist>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registrado', reg))
          .catch(err => console.log('SW fallo', err));
      });
    }
  </script>
  <script src="app.js?v=118"></script>
</body>
</html>
