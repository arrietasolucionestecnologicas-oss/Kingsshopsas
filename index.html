<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KingShop POS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>
<body>

  <div id="loader"><div class="spinner-border text-primary" role="status"></div><div class="mt-2 fw-bold text-muted">Sincronizando...</div></div>

  <div class="nav-bottom d-lg-none">
    <div class="nav-btn active" onclick="nav('pos', this)"><i class="fas fa-cash-register"></i><br>Venta</div>
    <div class="nav-btn" onclick="nav('inv', this)"><i class="fas fa-boxes"></i><br>Inventario</div>
    <div class="nav-btn" onclick="nav('ped', this)"><i class="fas fa-clipboard-list"></i><br>Pedidos</div>
    <div class="nav-btn" onclick="nav('fin', this)"><i class="fas fa-chart-pie"></i><br>Finanzas</div>
  </div>

  <div class="d-none d-lg-flex flex-column bg-white border-end vh-100 p-3 position-fixed" style="width: 250px; z-index:1000;">
    <h4 class="mb-4 text-primary fw-bold"><i class="fas fa-crown"></i> KINGSHOP</h4>
    <button class="btn btn-light text-start mb-2 nav-btn active" onclick="nav('pos', this)"><i class="fas fa-cash-register me-2"></i> Punto de Venta</button>
    <button class="btn btn-light text-start mb-2 nav-btn" onclick="nav('inv', this)"><i class="fas fa-boxes me-2"></i> Inventario</button>
    <button class="btn btn-light text-start mb-2 nav-btn" onclick="nav('ped', this)"><i class="fas fa-clipboard-list me-2"></i> Pedidos</button>
    <button class="btn btn-light text-start mb-2 nav-btn" onclick="nav('fin', this)"><i class="fas fa-chart-pie me-2"></i> Finanzas</button>
    <div class="mt-auto small text-muted">
      Usuario: <span id="user-display">Cargando...</span><br>
      v3.0 Stable
    </div>
  </div>

  <div class="main-content">
    
    <div id="view-pos" class="view-sec">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0 fw-bold">Punto de Venta</h5>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="loadData()"><i class="fas fa-sync"></i></button>
            <a href="dashboard.html" class="btn btn-sm btn-outline-dark"><i class="fas fa-chart-line"></i> BI</a>
        </div>
      </div>

      <div class="row g-3 h-100">
        <div class="col-lg-8 d-flex flex-column" style="height: calc(100vh - 140px);">
          <div class="input-group mb-3">
            <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
            <input type="text" id="pos-search" class="form-control" placeholder="Buscar producto..." onkeyup="renderPos()">
          </div>
          
          <div id="pos-list" class="flex-grow-1 overflow-auto pe-1"></div>
          <div id="msg-empty-pos" class="text-center text-muted mt-5" style="display:none;">No se encontraron productos</div>
        </div>

        <div class="col-lg-4 d-none d-lg-flex flex-column h-100 bg-white border rounded p-3 shadow-sm" id="desktop-cart-container">
          </div>
      </div>
    </div>

    <div id="view-inv" class="view-sec" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-3 sticky-top bg-light py-2">
        <h5 class="mb-0 fw-bold">Inventario</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-primary" onclick="abrirModalNuevo()">+ Nuevo</button>
          <button class="btn btn-sm btn-success" onclick="abrirModalWA()"><i class="fab fa-whatsapp"></i> Importar</button>
          <button class="btn btn-sm btn-info text-white" onclick="abrirModalProv()"><i class="fas fa-truck"></i> Provs</button>
        </div>
      </div>
      <input type="text" id="inv-search" class="form-control mb-3" placeholder="Filtrar inventario..." onkeyup="renderInv()">
      <div id="inv-list" class="pb-5"></div>
    </div>

    <div id="view-ped" class="view-sec" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3 sticky-top bg-light py-2">
            <h5 class="mb-0 fw-bold">Pedidos / Faltantes</h5>
            <button class="btn btn-sm btn-primary" onclick="abrirModalPed()">+ Pedir</button>
        </div>
        <div id="ped-list" class="pb-5"></div>
    </div>

    <div id="view-fin" class="view-sec" style="display:none;">
      <h5 class="mb-3 fw-bold">Finanzas & Caja</h5>
      
      <div class="row g-2 mb-4">
        <div class="col-4">
          <div class="card bg-primary text-white p-2 text-center h-100">
            <small>Caja Actual</small>
            <div class="fw-bold" id="bal-caja" style="font-size:0.9rem">$0</div>
          </div>
        </div>
        <div class="col-4">
          <div class="card bg-success text-white p-2 text-center h-100">
            <small>Venta Mes</small>
            <div class="fw-bold" id="bal-ventas" style="font-size:0.9rem">$0</div>
          </div>
        </div>
        <div class="col-4">
          <div class="card bg-warning text-dark p-2 text-center h-100">
            <small>Ganancia</small>
            <div class="fw-bold" id="bal-ganancia" style="font-size:0.9rem">$0</div>
          </div>
        </div>
      </div>

      <div class="card p-3 mb-3 border-0 shadow-sm">
        <h6 class="text-primary"><i class="fas fa-hand-holding-usd"></i> Registrar Abono</h6>
        <div class="input-group mb-2">
          <select id="ab-cli" class="form-select form-select-sm"></select>
        </div>
        <div class="input-group">
          <input type="number" id="ab-monto" class="form-control form-control-sm" placeholder="Monto abono">
          <button class="btn btn-sm btn-outline-primary" onclick="doAbono()">Registrar</button>
        </div>
      </div>

      <div class="card p-3 mb-3 border-0 shadow-sm">
        <h6 class="text-danger"><i class="fas fa-receipt"></i> Registrar Gasto</h6>
        <div class="row g-2 mb-2">
            <div class="col-6"><input type="text" id="g-desc" class="form-control form-control-sm" placeholder="Descripci√≥n"></div>
            <div class="col-6">
                <select id="g-cat" class="form-select form-select-sm">
                    <option value="Gastos Fijos">Fijos (Luz, Arriendo)</option>
                    <option value="Nomina">N√≥mina</option>
                    <option value="Transporte">Transporte</option>
                    <option value="Insumos">Insumos</option>
                    <option value="Publicidad">Publicidad</option>
                    <option value="Otros">Otros</option>
                </select>
            </div>
        </div>
        <div class="mb-2">
            <label class="small text-muted">Vincular a Venta (Opcional):</label>
            <select id="g-vinculo" class="form-select form-select-sm"></select>
        </div>
        <div class="input-group">
          <input type="number" id="g-monto" class="form-control form-control-sm" placeholder="Monto">
          <button class="btn btn-sm btn-outline-danger" onclick="doGasto()">Registrar</button>
        </div>
      </div>

      <h6 class="mt-4">Historial Reciente (50)</h6>
      <div id="hist-list" class="bg-white rounded shadow-sm p-2 mb-5"></div>
      
      <div class="text-center mb-5 pb-5">
          <button class="btn btn-outline-secondary btn-sm w-100" onclick="verBancos()">Ver Cuentas Bancarias</button>
      </div>
    </div>

  </div>

  <button id="btn-float-cart" class="btn btn-primary rounded-circle shadow p-3 d-lg-none" onclick="toggleMobileCart()">
    üõí 0
  </button>

  <div id="mobile-cart" class="d-lg-none"></div>

  <template id="tpl-cart">
    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <h5 class="mb-0 text-primary fw-bold"><i class="fas fa-shopping-cart"></i> Carrito</h5>
        <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">Limpiar</button>
    </div>
    
    <div class="flex-grow-1 overflow-auto mb-3" style="max-height: 40vh;">
        <div id="cart-items-list" class="text-muted small fst-italic">Selecciona productos...</div>
    </div>

    <div class="bg-light p-3 rounded">
        <div class="mb-2">
            <label class="small fw-bold">Cliente:</label>
            <input type="text" id="c-cliente" class="form-control form-control-sm" placeholder="Nombre cliente">
        </div>
        <div class="row g-2 mb-2">
            <div class="col-6">
                <label class="small fw-bold">M√©todo:</label>
                <select id="c-metodo" class="form-select form-select-sm" onchange="toggleIni()">
                    <option value="Contado">Contado</option>
                    <option value="Cr√©dito">Cr√©dito</option>
                    <option value="Transferencia">Transf.</option>
                </select>
            </div>
            <div class="col-6">
                <label class="small fw-bold">Cuotas:</label>
                <select id="c-cuotas" class="form-select form-select-sm" onchange="calcCart()">
                    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                </select>
            </div>
        </div>
        
        <div class="row g-2 mb-2 align-items-center">
            <div class="col-4">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="c-iva" onchange="calcCart()">
                    <label class="form-check-label small" for="c-iva">IVA</label>
                </div>
            </div>
            <div class="col-4">
                <input type="number" id="c-util" class="form-control form-control-sm" placeholder="% Util" value="30" onchange="calcCart()">
            </div>
            <div class="col-4">
                <input type="number" id="c-int" class="form-control form-control-sm" placeholder="% Int" value="0" onchange="calcCart()">
            </div>
        </div>

        <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="c-manual" onchange="toggleManual()">
            <label class="form-check-label small" for="c-manual">Precio Manual</label>
        </div>

        <hr class="my-2">
        <div class="d-flex justify-content-between align-items-end mb-2">
            <span class="h5 mb-0">Total:</span>
            <div class="text-end">
                <h3 class="mb-0 text-success fw-bold" id="res-cont">$0</h3>
                <input type="number" id="res-cont-input" class="form-control form-control-lg text-end fw-bold text-success" style="display:none;" value="0" onchange="calcCart()">
            </div>
        </div>
        
        <div id="row-cred" style="display:none;" class="alert alert-warning py-1 px-2 small">
            <div class="d-flex justify-content-between"><span>Inicial (30%):</span> <strong id="res-ini">$0</strong></div>
            <input type="number" id="c-inicial" class="form-control form-control-sm mt-1 mb-1" placeholder="Monto Inicial Manual" onchange="var v=parseFloat(this.value); calculatedValues.inicial=v; calcCart();">
            <div class="d-flex justify-content-between border-top pt-1 mt-1">
                <span>Cuota:</span> 
                <div class="text-end"><strong id="res-cuota-val">$0</strong><br><span id="res-cuota-txt" class="text-muted" style="font-size:0.7em"></span></div>
            </div>
        </div>

        <button class="btn btn-primary w-100 py-2 fw-bold mt-2" onclick="finalizarVenta()">COBRAR</button>
        <button class="btn btn-outline-secondary w-100 mt-2 d-lg-none" onclick="toggleMobileCart()">Cerrar</button>
    </div>
  </template>

  <div class="modal fade" id="modalEdicion" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">Editar Producto</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label>Nombre:</label><input type="text" id="inp-edit-nombre" class="form-control mb-2">
          <label>Categor√≠a:</label><select id="inp-edit-categoria" class="form-select mb-2"><option value="">Cargando...</option></select>
          <div class="row g-2">
              <div class="col-6"><label>Costo:</label><input type="number" id="inp-edit-costo" class="form-control mb-2"></div>
              <div class="col-6"><label>P. P√∫blico:</label><input type="number" id="inp-edit-publico" class="form-control mb-2"></div>
          </div>
          <label>Proveedor:</label><input type="text" id="inp-edit-proveedor" class="form-control mb-2">
          <label>Descripci√≥n:</label><textarea id="inp-edit-desc" class="form-control mb-2" rows="3"></textarea>
          
          <div class="form-check form-switch my-3 p-3 bg-light rounded border">
             <input class="form-check-input" type="checkbox" id="inp-edit-web" style="cursor:pointer;">
             <label class="form-check-label fw-bold" for="inp-edit-web">üåê Mostrar en P√°gina Web</label>
          </div>

          <label>Foto:</label><input type="file" id="inp-file-foto" class="form-control mb-2" onchange="previewFile()">
          <div class="text-center mt-2"><img id="img-preview-box" src="" style="max-height:150px; display:none; border-radius:5px;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto" onclick="eliminarProductoActual()">Eliminar</button>
          <button type="button" class="btn btn-dark" onclick="guardarCambiosAvanzado()">Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalNuevo" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Nuevo Producto</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label>Categor√≠a:</label>
          <select id="new-categoria" class="form-select mb-2" onchange="generarIDAuto()">
             <option value="">Seleccione...</option>
             <option value="Tecnologia">Tecnolog√≠a</option>
             <option value="Electrodomesticos">Electrodom√©sticos</option>
             <option value="Juguetes">Juguetes</option>
             <option value="Hogar">Hogar</option>
             <option value="Perfumes">Perfumes</option>
          </select>
          <label>ID (Auto):</label><input type="text" id="new-id" class="form-control mb-2" readonly>
          <label>Nombre:</label><input type="text" id="new-nombre" class="form-control mb-2">
          <label>Proveedor:</label><input type="text" id="new-proveedor" class="form-control mb-2">
          <div class="row g-2">
              <div class="col-6"><label>Costo:</label><input type="number" id="new-costo" class="form-control mb-2"></div>
              <div class="col-6"><label>P. P√∫blico:</label><input type="number" id="new-publico" class="form-control mb-2"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary w-100" onclick="crearProducto()">Crear</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalWA" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fab fa-whatsapp"></i> Importar Texto</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="wa-prov" class="form-control mb-2" placeholder="Proveedor (Opcional)">
          <select id="wa-cat" class="form-select mb-2">
             <option value="Tecnologia">Tecnolog√≠a</option>
             <option value="Juguetes">Juguetes</option>
             <option value="Hogar">Hogar</option>
          </select>
          <textarea id="wa-text" class="form-control" rows="10" placeholder="Pega aqu√≠ la lista de WhatsApp..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success w-100" onclick="procesarWA()">Procesar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalProv" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Proveedores</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
             <input type="text" id="new-prov-name" class="form-control" placeholder="Nombre">
             <input type="text" id="new-prov-tel" class="form-control" placeholder="Tel√©fono">
             <button class="btn btn-primary" onclick="guardarProvManual()">+</button>
          </div>
          <div id="list-provs"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalPed" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Nuevo Pedido / Faltante</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label>Producto:</label>
          <div class="input-group mb-2">
              <input type="text" id="pe-prod" class="form-control" list="list-prods-all">
              <datalist id="list-prods-all"></datalist>
          </div>
          <label>Proveedor:</label><input type="text" id="pe-prov" class="form-control mb-2">
          <label>Costo Estimado:</label><input type="number" id="pe-costo" class="form-control mb-2">
          <label>Notas:</label><textarea id="pe-nota" class="form-control mb-2" rows="2"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary w-100" onclick="savePed()">Guardar Pedido</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalEditPed" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Editar Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label>Producto:</label><input type="text" id="ed-ped-prod" class="form-control mb-2">
                <label>Proveedor:</label><input type="text" id="ed-ped-prov" class="form-control mb-2">
                <label>Costo Est:</label><input type="number" id="ed-ped-costo" class="form-control mb-2">
                <label>Notas:</label><textarea id="ed-ped-nota" class="form-control" rows="2"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-100" onclick="guardarEdicionPed()">Actualizar</button>
            </div>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="app.js"></script>
</body>
</html>
