<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kingshop BI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #1a1a2e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
    .top-bar { background: #16213e; padding: 15px 25px; border-bottom: 1px solid #0f3460; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
    .brand { color: #4ecca3; font-weight: 800; font-size: 1.5rem; letter-spacing: 1px; text-transform: uppercase; }
    .btn-close-dash { background: #e94560; border: none; padding: 8px 20px; color: white; border-radius: 30px; font-weight: bold; font-size: 0.85rem; transition: 0.3s; text-decoration: none; }
    .btn-close-dash:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(233, 69, 96, 0.4); color:white; }
    .filter-group { background: #16213e; margin: 20px; padding: 10px; border-radius: 10px; display: inline-flex; gap: 5px; border: 1px solid #0f3460; }
    .filter-btn { background: transparent; border: none; color: #a0a0a0; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
    .filter-btn.active { background: #0f3460; color: #4ecca3; }
    .kpi-card { background: #16213e; border-radius: 12px; padding: 20px; position: relative; overflow: hidden; height: 100%; transition: 0.3s; border: 1px solid transparent; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .kpi-card:hover { transform: translateY(-5px); border-color: #4ecca3; }
    .kpi-icon { position: absolute; right: -10px; top: -10px; font-size: 4rem; opacity: 0.05; transform: rotate(15deg); }
    .kpi-label { font-size: 0.8rem; text-transform: uppercase; color: #8892b0; letter-spacing: 1px; margin-bottom: 5px; }
    .kpi-value { font-size: 2rem; font-weight: 700; color: #fff; line-height: 1; }
    .kpi-sub { font-size: 0.85rem; margin-top: 8px; }
    .panel-box { background: #16213e; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 1px solid #1f2940; height: 100%; }
    .panel-title { font-weight: 700; color: #4ecca3; margin-bottom: 20px; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .table-dark-custom { width: 100%; font-size: 0.9rem; }
    .table-dark-custom td { padding: 10px 0; border-bottom: 1px solid #1f2940; color: #c0c0c0; }
    .table-dark-custom tr:last-child td { border-bottom: none; }
    .badge-rank { background: #0f3460; color: #4ecca3; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 10px; }
    .text-pos { color: #4ecca3; } .text-neg { color: #e94560; } .text-warn { color: #fca311; }
    #loader { position: fixed; inset: 0; background: rgba(26, 26, 46, 0.95); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner-border text-info" role="status"></div><div class="mt-3 text-muted fw-bold">Calculando Métricas...</div></div>

  <div class="top-bar">
    <div class="brand"><i class="fas fa-chart-line"></i> KINGSHOP <span style="color:#fff; font-size:0.9rem; font-weight:400;">Enterprise BI</span></div>
    <a class="btn-close-dash" href="index.html"><i class="fas fa-arrow-left"></i> TIENDA</a>
  </div>

  <div class="container-fluid px-4">
    <div class="d-flex justify-content-center">
      <div class="filter-group">
        <button class="filter-btn" onclick="loadDashboard('mes_actual')" id="btn-mes">ESTE MES</button>
        <button class="filter-btn" onclick="loadDashboard('mes_anterior')" id="btn-ant">MES ANTERIOR</button>
        <button class="filter-btn active" onclick="loadDashboard('anual')" id="btn-ano">AÑO 2025</button>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-3"><div class="kpi-card" style="border-left: 4px solid #4ecca3;"><i class="fas fa-dollar-sign kpi-icon"></i><div class="kpi-label">Ventas Brutas</div><div class="kpi-value" id="k-ventas">...</div><div class="kpi-sub text-success"><i class="fas fa-check-circle"></i> Ingresos Totales</div></div></div>
      <div class="col-md-3"><div class="kpi-card" style="border-left: 4px solid #fca311;"><i class="fas fa-chart-pie kpi-icon"></i><div class="kpi-label">Margen Real</div><div class="kpi-value" id="k-margen">...%</div><div class="kpi-sub" id="k-util-monto">Util: $0</div></div></div>
      <div class="col-md-3"><div class="kpi-card" style="border-left: 4px solid #e94560;"><i class="fas fa-hand-holding-usd kpi-icon"></i><div class="kpi-label">Cartera (Deuda)</div><div class="kpi-value text-neg" id="k-deuda">...</div><div class="kpi-sub text-muted">Pendiente de cobro</div></div></div>
      <div class="col-md-3"><div class="kpi-card" style="border-left: 4px solid #3a86ff;"><i class="fas fa-receipt kpi-icon"></i><div class="kpi-label">Ticket Promedio</div><div class="kpi-value" id="k-ticket">...</div><div class="kpi-sub text-muted">Por transacción</div></div></div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-lg-8"><div class="panel-box"><div class="panel-title"><span><i class="fas fa-chart-area"></i> Flujo de Caja (Ventas vs Gastos)</span> <small class="text-muted fw-normal">Comparativa Mensual</small></div><div style="height: 300px;"><canvas id="chart-flow"></canvas></div></div></div>
      <div class="col-lg-4"><div class="panel-box"><div class="panel-title"><span><i class="fas fa-wallet"></i> Distribución de Gastos</span></div><div style="height: 200px; position:relative;"><canvas id="chart-gastos"></canvas></div><div id="gastos-summary" class="mt-3 small text-muted text-center fst-italic"></div></div></div>
    </div>

    <div class="row g-3">
      <div class="col-md-4"><div class="panel-box"><div class="panel-title"><span><i class="fas fa-tags"></i> Top Categorías</span></div><div style="height: 200px;"><canvas id="chart-cats"></canvas></div></div></div>
      <div class="col-md-4"><div class="panel-box"><div class="panel-title"><span><i class="fas fa-crown"></i> Clientes VIP</span></div><table class="table-dark-custom" id="list-clientes"></table></div></div>
      <div class="col-md-4"><div class="panel-box" style="border-color: #e94560;"><div class="panel-title"><span class="text-neg"><i class="fas fa-bed"></i> Inventario Dormido</span></div><div class="alert alert-dark border-0 small mb-2 p-2"><i class="fas fa-info-circle"></i> Productos sin ventas en el periodo</div><table class="table-dark-custom" id="list-dormidos"></table></div></div>
    </div>
  </div>

  <script>
    // ============================================
    // ⚠️ PEGA AQUÍ TU URL (LA MISMA DE APP.JS)
    // ============================================
    const API_URL = "https://script.google.com/macros/s/AKfycbza8m9l6c_RS-3GJArGDHLwBbfkIiWGA1lbBL3yPoBdsYOPG03p7TQ4qrit61vsim5Y/exec"; 

    var chartFlow, chartGastos, chartCats;
    window.onload = function() { loadDashboard('anual'); };

    async function callAPI(action, data = null) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: action, data: data })
        });
        const result = await response.json();
        return result;
      } catch (e) {
        alert("Error de conexión: " + e.toString());
        return { exito: false, error: e.toString() };
      }
    }

    function loadDashboard(periodo) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      if(periodo=='mes_actual') document.getElementById('btn-mes').classList.add('active');
      else if(periodo=='mes_anterior') document.getElementById('btn-ant').classList.add('active');
      else document.getElementById('btn-ano').classList.add('active');
      document.getElementById('loader').style.display = 'flex';
      callAPI('getDashboardData', periodo).then(renderData);
    }

    function renderData(data) {
      document.getElementById('loader').style.display = 'none';
      document.getElementById('k-ventas').innerText = fmt(data.kpis.ventas);
      document.getElementById('k-margen').innerText = data.kpis.margen + "%";
      document.getElementById('k-util-monto').innerText = "Util: " + fmt(data.kpis.utilidad);
      document.getElementById('k-util-monto').className = data.kpis.utilidad >= 0 ? "kpi-sub text-pos" : "kpi-sub text-neg";
      document.getElementById('k-deuda').innerText = fmt(data.kpis.deuda);
      document.getElementById('k-ticket').innerText = fmt(data.kpis.ticket);

      renderFlowChart(data.charts.flujoVentas, data.charts.flujoGastos);
      renderGastosChart(data.charts.gastosLabels, data.charts.gastosData);
      renderCatsChart(data.charts.catsLabels, data.charts.catsData);

      var htmlCli = "";
      data.listas.clientes.forEach((c, i) => { htmlCli += `<tr><td><span class="badge-rank">#${i+1}</span> ${c.k}</td><td class="text-end fw-bold text-pos">${fmt(c.v)}</td></tr>`; });
      document.getElementById('list-clientes').innerHTML = htmlCli || "<tr><td class='text-center text-muted'>Sin datos</td></tr>";

      var htmlSleep = "";
      data.listas.dormidos.forEach(p => { htmlSleep += `<tr><td>${p.nombre}</td><td class="text-end text-muted small">Costo: ${fmt(p.costo)}</td></tr>`; });
      document.getElementById('list-dormidos').innerHTML = htmlSleep || "<tr><td class='text-center text-muted'>¡Todo se vendió!</td></tr>";
    }

    function renderFlowChart(vData, gData) {
      var ctx = document.getElementById('chart-flow').getContext('2d'); if(chartFlow) chartFlow.destroy();
      chartFlow = new Chart(ctx, { type: 'line', data: { labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'], datasets: [ { label: 'Ingresos', data: vData, borderColor: '#4ecca3', backgroundColor: 'rgba(78, 204, 163, 0.1)', tension: 0.4, fill: true }, { label: 'Gastos', data: gData, borderColor: '#e94560', backgroundColor: 'rgba(0,0,0,0)', tension: 0.4, borderDash: [5, 5] } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#ccc' } } }, scales: { y: { grid: { color: '#1f2940' }, ticks: { color: '#8892b0' } }, x: { grid: { display: false }, ticks: { color: '#8892b0' } } } } });
    }
    function renderGastosChart(labels, values) {
      var ctx = document.getElementById('chart-gastos').getContext('2d'); if(chartGastos) chartGastos.destroy();
      if(values.length === 0) { document.getElementById('gastos-summary').innerText = "Sin gastos registrados en este periodo."; return; } else { document.getElementById('gastos-summary').innerText = ""; }
      chartGastos = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: values, backgroundColor: ['#e94560', '#fca311', '#3a86ff', '#8338ec', '#ff006e'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#ccc', boxWidth: 10 } } }, cutout: '70%' } });
    }
    function renderCatsChart(labels, values) {
      var ctx = document.getElementById('chart-cats').getContext('2d'); if(chartCats) chartCats.destroy();
      chartCats = new Chart(ctx, { type: 'bar', data: { labels: labels.slice(0,5), datasets: [{ label: 'Ventas', data: values.slice(0,5), backgroundColor: '#3a86ff', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { color: '#ccc' }, grid: { display: false } } } } });
    }
    function fmt(n) { return "$" + Number(n).toLocaleString(); }
  </script>
</body>
</html>
